<!-- 931a24e2-965c-445b-841d-fddc6450bd8f 74516625-57fa-4568-b631-7d95e408cd17 -->
# Refactor testintegrated2 main and add test harness

- We will rename the current file so it becomes a reusable main module with `main_setup()` and `main_loop()` instead of Arduino `setup()`/`loop()`. Then add a separate test runner `test_main.cpp` that calls these functions and injects keyboard events.

### Steps
1) Rename file
- Rename `test/test_integrated_2/test_main.cpp` → `test/test_integrated_2/main.cpp`.

2) Extract Arduino entry points to reusable functions
- In `test/test_integrated_2/main.cpp`:
  - Change `void setup()` → `void main_setup()` and `void loop()` → `void main_loop()`.
  - Keep bodies unchanged.

3) Add a small header for linkage
- Create `test/test_integrated_2/main_app.h` with:
```cpp
#pragma once
void main_setup();
void main_loop();
```

4) Add a separate test harness file
- Create `test/test_integrated_2/test_main.cpp` that:
  - Includes `Arduino.h`, `unity.h`, `main_app.h`, `key_processor.h`, `lvgl_helper.h`, and `core_eventing/event_system.h`.
  - Defines a lightweight `KeyboardInputSimulator` that publishes key events via `KeyProcessor::sendKeyToLVGL` and function key events via the event bus.
  - Implements Arduino `setup()` calling `Serial.begin(...)`, then `main_setup()`, then schedules/starts simulated input (e.g., after a brief delay).
  - Implements Arduino `loop()` calling `main_loop()`, processes events (`EventSystem::instance().processAllEvents()`), and runs the simulator scenarios (normal input, rapid input, backspace, enter). Keep it guarded so it runs once or at intervals.

5) Optional wrapper for reuse in production builds (if needed later)
- If we ever want to reuse `main.cpp` as an actual firmware entry point, we can add optional wrappers gated by a macro:
```cpp
#ifndef DICT_TEST_BUILD
void setup() { main_setup(); }
void loop() { main_loop(); }
#endif
```
- Not needed for this test folder unless you request it.

### Snippets (essential only)
- `test/test_integrated_2/main_app.h`:
```cpp
#pragma once
void main_setup();
void main_loop();
```

- `test/test_integrated_2/test_main.cpp` skeleton:
```cpp
#include <Arduino.h>
#include <unity.h>
#include "main_app.h"
#include "key_processor.h"
#include "lvgl_helper.h"
#include "core_eventing/event_system.h"

using namespace dict;

class KeyboardInputSimulator {
 public:
  void type(const char* s) {
    for (const char* p=s; *p; ++p) publishKey(*p);
  }
  void enter() { publishKey('\n', 0x28, 0); }
  void backspace() { publishKey(0x08, 0x2A, 0); }
 private:
  void publishKey(char ch, uint8_t code=0, uint8_t mod=0) {
    KeyProcessor kp; kp.initialize();
    kp.sendKeyToLVGL(ch, code, mod);
  }
};

static KeyboardInputSimulator sim;
static bool ran = false;

void setup() {
  Serial.begin(115200);
  delay(2000);
  main_setup();
}

void loop() {
  main_loop();
  EventSystem::instance().processAllEvents();
  if (!ran && millis() > 5000) {
    sim.type("hello"); sim.enter();
    sim.type("abc"); for (int i=0;i<3;i++) sim.backspace();
    ran = true;
  }
  delay(10);
}
```

### Notes
- We keep the integrated logic intact; only symbol names change and we add a thin test harness.
- No behavior changes to your UI/audio/network flows.
- Simulator drives the existing event bus, matching real user flows.


### To-dos

- [ ] Rename test/test_integrated_2/test_main.cpp to main.cpp
- [ ] Rename setup/loop to main_setup/main_loop in main.cpp
- [ ] Create test/test_integrated_2/main_app.h (declare main_setup/main_loop)
- [ ] Create test/test_integrated_2/test_main.cpp with simulator and calls
- [ ] Add optional setup/loop wrappers guarded by macro (if desired)